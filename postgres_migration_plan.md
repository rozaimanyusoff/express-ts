# PostgreSQL Migration Plan for Express TypeScript Backend

## Overview
This document outlines all the changes required to migrate the Express TypeScript backend from **MySQL** to **PostgreSQL**.

## 1. Dependencies Update

### Current Setup (MySQL)
```json
"mysql2": "^3.13.0"
```

### Required Changes
Replace `mysql2` with `pg` (PostgreSQL client) and `pg-pool` for connection pooling:

```bash
npm uninstall mysql2
npm install pg pg-pool
npm install --save-dev @types/pg
```

**Modified package.json dependencies:**
```json
"pg": "^8.11.0",
"pg-pool": "^3.6.0"
```

---

## 2. Database Connection Configuration

### Current File: `src/utils/db.ts`

#### Changes Required:

1. **Replace import statement:**
   ```typescript
   // OLD
   import * as mysql from 'mysql2/promise';
   
   // NEW
   import { Pool } from 'pg';
   import { ConnectionPool } from 'pg-pool';
   ```

2. **Update pool configuration:**
   ```typescript
   // OLD (MySQL)
   const poolConfig = {
     acquireTimeout: 10000,
     connectionLimit: 10,
     connectTimeout: 10000,
     database: process.env.DB_NAME,
     enableKeepAlive: true,
     host: process.env.DB_HOST,
     idleTimeout: 60000,
     keepAliveInitialDelay: 0,
     maxIdle: 10,
     password: process.env.DB_PASSWORD,
     port: parseInt(process.env.DB_PORT!),
     user: process.env.DB_USER,
     waitForConnections: true,
   };
   
   // NEW (PostgreSQL)
   const poolConfig = {
     host: process.env.DB_HOST,
     port: parseInt(process.env.DB_PORT!) || 5432,
     database: process.env.DB_NAME,
     user: process.env.DB_USER,
     password: process.env.DB_PASSWORD,
     max: 10,  // max clients in pool
     idleTimeoutMillis: 30000,
     connectionTimeoutMillis: 2000,
   };
   ```

3. **Update pool instantiation:**
   ```typescript
   // OLD
   const pool: mysql.Pool = mysql.createPool(poolConfig);
   
   // NEW
   const pool = new Pool(poolConfig);
   ```

4. **Connection query syntax changes:**
   - MySQL: `pool.query(sql, [params])`  → Returns `[rows, fields]`
   - PostgreSQL: `pool.query(sql, [params])` → Returns `QueryResult` object
   
   The destructuring pattern changes from:
   ```typescript
   // OLD (MySQL returns tuple)
   const [rows] = await pool.query(sql, params);
   
   // NEW (PostgreSQL returns object with .rows property)
   const result = await pool.query(sql, params);
   const rows = result.rows;
   ```

---

## 3. SQL Syntax Conversions

### 3.1 Data Types

| MySQL | PostgreSQL | Notes |
|-------|-----------|-------|
| `INT AUTO_INCREMENT` | `SERIAL` or `INT GENERATED BY DEFAULT AS IDENTITY` | For auto-increment |
| `VARCHAR(255)` | `VARCHAR(255)` | Same syntax |
| `TEXT` | `TEXT` | Same syntax |
| `DATETIME` | `TIMESTAMP` | PostgreSQL uses TIMESTAMP |
| `CURRENT_TIMESTAMP` | `CURRENT_TIMESTAMP` | Same |
| `BOOLEAN` | `BOOLEAN` | Same syntax |
| `JSON` | `JSONB` | PostgreSQL prefers JSONB for better indexing |
| `COLLATE utf8mb4_0900_ai_ci` | Remove or use `COLLATE "en_US.UTF-8"` | PostgreSQL handles UTF-8 by default |

### 3.2 SQL Statement Changes

#### Table Creation
```sql
-- OLD (MySQL)
CREATE TABLE `users` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci,
  PRIMARY KEY (`id`),
  KEY `fk_users_dept` (`department_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- NEW (PostgreSQL)
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255),
  CONSTRAINT fk_users_dept FOREIGN KEY (department_id) REFERENCES departments(id)
);
```

#### Identifiers
- MySQL: Backticks `` `column_name` ``
- PostgreSQL: Double quotes `"column_name"` or unquoted lowercase names

```typescript
// OLD
const sql = `SELECT * FROM \`users\` WHERE \`id\` = ?`;

// NEW
const sql = `SELECT * FROM users WHERE id = $1`;
```

#### Query Placeholders
- MySQL: `?` for parameters
- PostgreSQL: `$1`, `$2`, etc. for numbered parameters OR `$` prefix for positional

```typescript
// OLD (MySQL)
const [rows] = await pool.query(
  `SELECT * FROM users WHERE id = ? AND status = ?`,
  [userId, status]
);

// NEW (PostgreSQL)
const result = await pool.query(
  `SELECT * FROM users WHERE id = $1 AND status = $2`,
  [userId, status]
);
const rows = result.rows;
```

#### String Functions
| Operation | MySQL | PostgreSQL |
|-----------|-------|-----------|
| Case insensitive | `COLLATE utf8mb4_general_ci` | `ILIKE` operator |
| Concat | `CONCAT()` | `\|\|` operator or `CONCAT()` |
| String length | `CHAR_LENGTH()` or `LENGTH()` | `LENGTH()` or `CHAR_LENGTH()` |
| Substring | `SUBSTR()` | `SUBSTRING()` |
| Upper/Lower | `UPPER()`, `LOWER()` | `UPPER()`, `LOWER()` |

```sql
-- OLD (MySQL)
SELECT * FROM users WHERE UPPER(name) LIKE 'JOH%'

-- NEW (PostgreSQL)
SELECT * FROM users WHERE name ILIKE 'joh%'
```

#### JSON Operations
```sql
-- OLD (MySQL JSON)
SELECT * FROM data WHERE JSON_EXTRACT(metadata, '$.key') = 'value'

-- NEW (PostgreSQL JSONB)
SELECT * FROM data WHERE metadata->>'key' = 'value'
-- OR
SELECT * FROM data WHERE metadata @> '{"key":"value"}'::jsonb
```

#### Date/Time Functions
```sql
-- OLD (MySQL)
SELECT DATE_FORMAT(created_at, '%Y-%m-%d') FROM logs

-- NEW (PostgreSQL)
SELECT TO_CHAR(created_at, 'YYYY-MM-DD') FROM logs
-- OR
SELECT DATE(created_at) FROM logs
```

#### NULL Comparisons
```sql
-- Both MySQL and PostgreSQL (same)
SELECT * FROM users WHERE email IS NULL
SELECT * FROM users WHERE email IS NOT NULL
```

#### LIMIT/OFFSET
```sql
-- Both MySQL and PostgreSQL (same)
SELECT * FROM users LIMIT 10 OFFSET 20
```

#### AUTO_INCREMENT
```sql
-- OLD (MySQL)
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY
)

-- NEW (PostgreSQL)
CREATE TABLE users (
  id SERIAL PRIMARY KEY
)
-- OR
CREATE TABLE users (
  id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY
)
```

---

## 4. Code Changes in Model Files

### Pattern: From MySQL to PostgreSQL

#### Current Pattern (MySQL)
```typescript
export const getUsers = async () => {
  const [rows] = await pool.query(`SELECT * FROM users`);
  return rows;
};

export const getUserById = async (id: number) => {
  const [rows] = await pool.query(
    `SELECT * FROM users WHERE id = ?`,
    [id]
  );
  return rows[0];
};
```

#### Updated Pattern (PostgreSQL)
```typescript
export const getUsers = async () => {
  const result = await pool.query(`SELECT * FROM users`);
  return result.rows;
};

export const getUserById = async (id: number) => {
  const result = await pool.query(
    `SELECT * FROM users WHERE id = $1`,
    [id]
  );
  return result.rows[0];
};
```

### Key Files to Update (in src/p.*/)
- All `*Model.ts` files in each module
- Pattern: `[rows]` → `result.rows`
- Pattern: `?` placeholders → `$1`, `$2`, etc.

---

## 5. Environment Variables

### Update `.env` file:

```env
# OLD (MySQL)
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=password
DB_NAME=assetdb

# NEW (PostgreSQL)
DB_HOST=localhost
DB_PORT=5432  # Default PostgreSQL port
DB_USER=postgres
DB_PASSWORD=password
DB_NAME=assetdb
```

---

## 6. Database Schema Migration

### Step-by-Step:

1. **Export current MySQL schema:**
   ```bash
   mysqldump -h localhost -u root -p assetdb > backup.sql
   ```

2. **Convert MySQL schema to PostgreSQL:**
   - Use online converter or manual conversion
   - Key changes:
     - Remove MySQL-specific directives
     - Replace backticks with double quotes or remove
     - Remove `CHARACTER SET` and `COLLATE` clauses
     - Convert `AUTO_INCREMENT` to `SERIAL`
     - Convert table engine definitions

3. **Create PostgreSQL database:**
   ```bash
   createdb -U postgres assetdb
   ```

4. **Import converted schema:**
   ```bash
   psql -U postgres -d assetdb -f converted_schema.sql
   ```

5. **Migrate data (if needed):**
   - Use tools like `pgloader` for automated migration
   - Or use ETL scripts to transform data

---

## 7. Feature-Specific Changes

### 7.1 BLOB/Binary Data
- PostgreSQL uses `BYTEA` type instead of `BLOB`

### 7.2 TRANSACTIONS
```typescript
// OLD (MySQL)
const connection = await pool.getConnection();
await connection.beginTransaction();
try {
  await connection.query(sql1, params1);
  await connection.query(sql2, params2);
  await connection.commit();
} catch (err) {
  await connection.rollback();
} finally {
  connection.release();
}

// NEW (PostgreSQL)
const client = await pool.connect();
try {
  await client.query('BEGIN');
  await client.query(sql1, params1);
  await client.query(sql2, params2);
  await client.query('COMMIT');
} catch (err) {
  await client.query('ROLLBACK');
  throw err;
} finally {
  client.release();
}
```

### 7.3 Batch Inserts
```typescript
// OLD (MySQL)
await pool.query(
  `INSERT INTO users (name, email) VALUES (?, ?), (?, ?)`,
  ['John', 'john@example.com', 'Jane', 'jane@example.com']
);

// NEW (PostgreSQL) - Use prepared statements or VALUES clause
await pool.query(
  `INSERT INTO users (name, email) VALUES ($1, $2), ($3, $4)`,
  ['John', 'john@example.com', 'Jane', 'jane@example.com']
);
```

---

## 8. Testing Checklist

- [ ] All `.env` variables updated
- [ ] `db.ts` updated with PostgreSQL pool configuration
- [ ] All `*Model.ts` files converted (query syntax, parameter placeholders)
- [ ] All SQL schema files converted
- [ ] Database created and schema imported
- [ ] Test basic CRUD operations
- [ ] Test complex queries (JOINs, subqueries)
- [ ] Test transactions
- [ ] Test batch operations
- [ ] Test file uploads (if applicable)
- [ ] Test WebSocket functionality (if applicable)
- [ ] Performance testing

---

## 9. Common Issues and Solutions

### Issue 1: Connection Pooling Timeouts
**Solution:** Adjust `idleTimeoutMillis` and `connectionTimeoutMillis` in pool config

### Issue 2: Query Parameter Binding
**Solution:** Ensure all queries use `$1`, `$2` syntax, not `?`

### Issue 3: Case Sensitivity
- PostgreSQL is case-sensitive by default (unlike MySQL)
- Solution: Use lowercase table/column names or quote identifiers

### Issue 4: JSON Type Differences
- PostgreSQL JSONB is stricter than MySQL JSON
- Solution: Validate JSON structure before insertion

### Issue 5: NULL and Empty String Handling
- PostgreSQL treats empty string `''` differently than MySQL
- Solution: Be explicit about NULL vs empty string checks

---

## 10. Migration Timeline

1. **Phase 1:** Update dependencies and db.ts
2. **Phase 2:** Convert SQL schema files
3. **Phase 3:** Update all model files (parameter placeholders, result destructuring)
4. **Phase 4:** Update transaction code (if any)
5. **Phase 5:** Database setup and data migration
6. **Phase 6:** Testing and bug fixes
7. **Phase 7:** Performance optimization
8. **Phase 8:** Production migration

---

## 11. Rollback Plan

- Maintain MySQL database until PostgreSQL is fully tested
- Keep backup of all original SQL and code
- Version control all changes for easy rollback
- Test all features in staging before production migration

---

## 12. Additional Resources

- PostgreSQL Documentation: https://www.postgresql.org/docs/
- pg npm package: https://www.npmjs.com/package/pg
- MySQL to PostgreSQL migration guide: https://wiki.postgresql.org/wiki/Convert_from_MySQL_to_PostgreSQL
- Online SQL converter: https://www.pgconverter.com/ or https://www.convert-in.com/mysql2pgsql.htm

---

## 13. Quick Reference: Syntax Changes

| Item | MySQL | PostgreSQL |
|------|-------|-----------|
| Query param | `?` | `$1, $2, ...` |
| Result structure | `[rows, fields]` | `{ rows, fields, ... }` |
| Connection pool | `mysql.createPool()` | `new Pool()` |
| Auto-increment | `AUTO_INCREMENT` | `SERIAL` |
| Table quotes | `` `table` `` | `"table"` or unquoted |
| Date function | `DATE_FORMAT()` | `TO_CHAR()` |
| String concat | `CONCAT()` | `\|\|` |
| Case-insensitive search | `LIKE` + COLLATE | `ILIKE` |
| JSON extract | `JSON_EXTRACT()` | `->>` or `@>` |
| NULL check | `IS NULL` | `IS NULL` (same) |
| Identity | `AUTO_INCREMENT` | `GENERATED AS IDENTITY` |
